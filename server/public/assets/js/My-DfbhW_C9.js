import{r as a,o as e,e as l,f as u,h as i,k as n,au as t,g as s,m as o,$ as r,av as v,p as d,v as c,F as m,x as p,i as g,aw as _,a2 as f,c as y,j as k,am as h,an as b,ao as C,a0 as I,ax as w,a1 as x,ay as U,I as z,a4 as $,l as j,az as F,a7 as O,aA as K,D as V,aB as q,n as D,z as M,_ as A,ag as B}from"./vendor-yaG8ImNT.js";import{f as R,a as S,c as E}from"./formatDate-Cfm9J1s9.js";import{_ as G,u as H,i as J}from"./index-k-75TJoX.js";import{_ as L}from"./ImageInfoModal-BfmZxevO.js";const N={class:"my-images"},P={class:"card-title"},Q={class:"album-list-overview"},T={key:1,class:"none-cover"},W={key:0},X={key:1,class:"image-grid"},Y={class:"image-info"},Z={class:"image-tags"},aa={class:"pagination"},ea={key:1,style:{"margin-top":"10px"}},la={key:1,class:"image-select-grid"},ua=["onClick"],ia=["src","alt"],na={style:{"text-align":"center","margin-top":"5px","font-size":"12px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},ta={class:"pagination",style:{"margin-top":"20px"}},sa=G({__name:"My",setup(G){const sa=H(),oa=a(!1),ra=a(!1),va=a([]),da=a(0),ca=a(1),ma=a(12),pa=a(!1),ga=a({}),_a=a(0),fa=a([]),ya=a(0),ka=a(null),ha=a(!1),ba=a(!1),Ca=a(null),Ia=a({_id:null,name:"",permission:"public",coverImage:null}),wa={name:[{required:!0,message:"请输入相册名称",trigger:"blur"}],permission:[{required:!0,message:"请选择权限",trigger:"change"}]},xa=a(!1),Ua=a(null),za=a(!1),$a=a(!1),ja=a([]),Fa=a(0),Oa=a(1),Ka=a(20),Va=async()=>{var a;oa.value=!0;try{const a={page:ca.value,limit:ma.value};void 0!==ka.value&&null!==ka.value?a.albumId=ka.value._id:a.albumId="standalone";const{data:e}=await J.post("/api/auth/my",$.stringify(a));va.value=e.images,da.value=e.total}catch({response:e}){z.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{oa.value=!1}},qa=async()=>{var a;ra.value=!0;try{const{data:a}=await J.post("/api/auth/albums/my");fa.value=a.albums||[],ya.value=a.standaloneCount||0}catch({response:e}){z.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{ra.value=!1}},Da=async()=>{var a;$a.value=!0;try{const{data:a}=await J.post("/api/auth/my",$.stringify({page:Oa.value,limit:Ka.value}));ja.value=a.images,Fa.value=a.total}catch({response:e}){z.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{$a.value=!1}},Ma=a=>{ca.value=a,Va()},Aa=a=>{ka.value=a,ca.value=1,da.value=0,va.value=[],Va()},Ba=()=>{ba.value=!1,Ia.value={_id:null,name:"",permission:"public",tags:[],coverImage:null},ha.value=!0,Ca.value&&Ca.value.resetFields()},Ra=async()=>{var a;try{await Ca.value.validate();const a={name:Ia.value.name,permission:Ia.value.permission,coverImage:Ia.value.coverImage?Ia.value.coverImage._id:null};if(ba.value?(await J.patch(`/api/auth/albums/${Ia.value._id}`,a),z.success("相册更新成功")):(await J.post("/api/auth/albums",a),z.success("相册创建成功")),ha.value=!1,qa(),ba.value&&ka.value&&ka.value._id===Ia.value._id){-1!==fa.value.findIndex((a=>a._id===Ia.value._id))&&qa()}}catch({response:e}){z.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}},Sa=async(a,e)=>{var l;try{await J.patch(`/api/auth/images/${a}/album`,{albumId:e}),z.success(e?"图片已添加到相册":"图片已移出相册"),Va(),qa()}catch({response:u}){z.error(null==(l=null==u?void 0:u.data)?void 0:l.error)}},Ea=async()=>{var a;if(Ua.value)try{const a=Ua.value._id;await J.patch(`/api/auth/images/${a}/tags`,{tags:Ua.value.tags}),z.success("图片标签更新成功"),xa.value=!1,Va()}catch({response:e}){z.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}},Ga=()=>{Oa.value=1,ja.value=[],Fa.value=0,Da(),za.value=!0},Ha=()=>{Ia.value.coverImage=null};return e((()=>{qa(),Aa(null)})),(a,e)=>{const $=f,G=y("router-link"),H=v,Ja=r,La=x,Na=F,Pa=O,Qa=A,Ta=M,Wa=D,Xa=V,Ya=_,Za=t,ae=C,ee=b,le=w,ue=I,ie=h,ne=U;return u(),l("div",N,[i(Ja,null,{title:n((()=>[s("div",P,[e[17]||(e[17]=s("span",null,"我的图片",-1)),s("div",null,[i($,{style:{"margin-right":"10px"},onClick:Ba},{default:n((()=>e[15]||(e[15]=[d("创建相册")]))),_:1,__:[15]}),i($,{type:"primary"},{default:n((()=>[i(G,{to:"/"},{default:n((()=>[i(k(B)),e[16]||(e[16]=d(" 上传图片 "))])),_:1,__:[16]})])),_:1})])])])),default:n((()=>[i(Za,{spinning:oa.value||ra.value},{default:n((()=>[s("div",Q,[i(Ja,{hoverable:"",onClick:e[0]||(e[0]=a=>Aa(null))},{default:n((()=>[i(H,{title:"独立图片"},{description:n((()=>[d("共 "+c(ya.value)+" 张",1)])),_:1})])),_:1}),(u(!0),l(m,null,p(fa.value,(a=>(u(),o(Ja,{hoverable:"",key:a._id,onClick:e=>Aa(a)},{cover:n((()=>[a.coverImage?(u(),o(La,{key:0,src:k(sa).config.site.url+a.coverImage.thumb,preview:!1},null,8,["src"])):(u(),l("div",T,"无封面"))])),actions:n((()=>[i($,{type:"link",onClick:j((e=>(a=>{ba.value=!0,Ia.value={_id:a._id,name:a.name,permission:a.permission,tags:a.tags||[],coverImage:a.coverImage||null},ha.value=!0,Ca.value&&Ca.value.resetFields()})(a)),["stop"])},{default:n((()=>e[18]||(e[18]=[d("编辑")]))),_:2,__:[18]},1032,["onClick"]),i($,{type:"link",danger:"",onClick:j((e=>(a=>{U.confirm({title:"确认删除相册",content:`确定要删除相册 "${a.name}" 吗？相册内的图片将被移出相册，但不会被删除。`,async onOk(){var e;try{await J.delete(`/api/auth/albums/${a._id}`),z.success("相册已删除，图片已移出"),qa(),ka.value&&ka.value._id===a._id&&Aa(null)}catch({response:l}){z.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}}})})(a)),["stop"])},{default:n((()=>e[19]||(e[19]=[d("删除")]))),_:2,__:[19]},1032,["onClick"])])),default:n((()=>[i(H,{title:a.name},{description:n((()=>[d("权限: "+c("public"===a.permission?"公开":"私有"),1)])),_:2},1032,["title"])])),_:2},1032,["onClick"])))),128))]),s("h2",null,[d(c(ka.value?ka.value.name:"独立图片")+" ",1),ka.value?(u(),l("small",W,"("+c("public"===ka.value.permission?"公开":"私有")+")",1)):g("",!0)]),0!==va.value.length||oa.value?(u(),l("div",X,[(u(!0),l(m,null,p(va.value,(a=>(u(),l("div",{key:a._id,class:"image-item"},[i(Ja,{hoverable:""},{cover:n((()=>[i(La,{src:k(sa).config.site.url+a.thumb,preview:{visible:!1},onClick:e=>(a=>{ga.value=a,pa.value=!0})(a)},null,8,["src","onClick"])])),actions:n((()=>[i($,{type:"link",onClick:e=>k(E)(e,a,k(sa))},{default:n((()=>[i(k(K)),e[20]||(e[20]=d(" 复制 "))])),_:2,__:[20]},1032,["onClick"]),i(Xa,null,{overlay:n((()=>[i(Wa,null,{default:n((()=>[i(Ta,{key:"album",title:"修改相册"},{default:n((()=>[i(Qa,{disabled:!a.album,onClick:e=>Sa(a._id,null)},{default:n((()=>e[22]||(e[22]=[d(" 独立图片 ")]))),_:2,__:[22]},1032,["disabled","onClick"]),(u(!0),l(m,null,p(fa.value,(e=>(u(),o(Qa,{key:e._id,disabled:a.album===e._id,onClick:l=>Sa(a._id,e._id)},{default:n((()=>[d(c(e.name),1)])),_:2},1032,["disabled","onClick"])))),128))])),_:2},1024),i(Qa,{onClick:e=>(a=>{Ua.value=a,xa.value=!0})(a)},{default:n((()=>[d(c(a.tags.length?"修改标签":"添加标签"),1)])),_:2},1032,["onClick"]),i(Qa,{onClick:e=>(async a=>{U.confirm({title:"确认删除",content:`确定要删除图片 "${a.filename}" 吗？`,async onOk(){var e;try{await J.delete(`/api/auth/images/${a._id}`),z.success("删除成功"),Va(),ka.value||qa()}catch({response:l}){z.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}}})})(a)},{default:n((()=>e[23]||(e[23]=[d("删除图片")]))),_:2,__:[23]},1032,["onClick"])])),_:2},1024)])),default:n((()=>[s("a",{class:"ant-dropdown-link",onClick:e[1]||(e[1]=j((()=>{}),["prevent"]))},[i(k(q)),e[21]||(e[21]=d(" 更多 "))])])),_:2},1024)])),default:n((()=>[i(H,null,{title:n((()=>[d(c(a.filename),1)])),description:n((()=>[s("div",Y,[s("span",null,c(k(R)(a.size)),1),s("span",null,c(k(S)(a.date)),1)]),s("div",Z,[(u(!0),l(m,null,p(a.tags,(a=>(u(),o(Pa,{key:a},{default:n((()=>[d(c(a),1)])),_:2},1024)))),128))])])),_:2},1024)])),_:2},1024)])))),128))])):(u(),o(Na,{key:0,description:"暂无图片"})),s("div",aa,[i(Ya,{current:ca.value,"onUpdate:current":e[2]||(e[2]=a=>ca.value=a),total:da.value,"page-size":ma.value,onChange:Ma},null,8,["current","total","page-size"])])])),_:1},8,["spinning"])])),_:1}),i(L,{modelValue:pa.value,"onUpdate:modelValue":e[3]||(e[3]=a=>pa.value=a),imageInfo:ga.value,"onUpdate:imageInfo":e[4]||(e[4]=a=>ga.value=a),imageKey:_a.value,"onUpdate:imageKey":e[5]||(e[5]=a=>_a.value=a),images:va.value},null,8,["modelValue","imageInfo","imageKey","images"]),i(ne,{open:ha.value,"onUpdate:open":e[8]||(e[8]=a=>ha.value=a),title:ba.value?"编辑相册":"创建相册",onOk:Ra,onCancel:e[9]||(e[9]=a=>ha.value=!1)},{default:n((()=>[i(ie,{model:Ia.value,rules:wa,ref_key:"albumFormRef",ref:Ca,layout:"vertical"},{default:n((()=>[i(ee,{label:"相册名称",name:"name"},{default:n((()=>[i(ae,{value:Ia.value.name,"onUpdate:value":e[6]||(e[6]=a=>Ia.value.name=a),placeholder:"请输入相册名称"},null,8,["value"])])),_:1}),i(ee,{label:"权限",name:"permission"},{default:n((()=>[i(ue,{value:Ia.value.permission,"onUpdate:value":e[7]||(e[7]=a=>Ia.value.permission=a),placeholder:"请选择相册权限"},{default:n((()=>[i(le,{value:"public"},{default:n((()=>e[24]||(e[24]=[d("公开")]))),_:1,__:[24]}),i(le,{value:"private"},{default:n((()=>e[25]||(e[25]=[d("私有")]))),_:1,__:[25]})])),_:1},8,["value"])])),_:1}),ba.value?(u(),o(ee,{key:0,label:"封面图片"},{default:n((()=>[i($,{type:"primary",style:{"margin-right":"10px"},onClick:Ga},{default:n((()=>e[26]||(e[26]=[d("选择图片")]))),_:1,__:[26]}),Ia.value.coverImage?(u(),o($,{key:0,type:"primary",danger:"",onClick:Ha},{default:n((()=>e[27]||(e[27]=[d("移除封面")]))),_:1,__:[27]})):g("",!0),Ia.value.coverImage?(u(),l("div",ea,[i(La,{src:k(sa).config.site.url+Ia.value.coverImage.thumb,height:200},null,8,["src"])])):g("",!0)])),_:1})):g("",!0)])),_:1},8,["model"])])),_:1},8,["open","title"]),i(ne,{open:xa.value,"onUpdate:open":e[11]||(e[11]=a=>xa.value=a),title:"标签",onOk:Ea,onCancel:e[12]||(e[12]=a=>xa.value=!1)},{default:n((()=>[i(ue,{value:Ua.value.tags,"onUpdate:value":e[10]||(e[10]=a=>Ua.value.tags=a),mode:"tags",placeholder:"输入标签，按回车键添加",style:{width:"100%"}},null,8,["value"])])),_:1},8,["open"]),i(ne,{open:za.value,"onUpdate:open":e[14]||(e[14]=a=>za.value=a),title:"选择相册封面",width:"80%",footer:null},{default:n((()=>[i(Za,{spinning:$a.value},{default:n((()=>[0!==ja.value.length||$a.value?(u(),l("div",la,[(u(!0),l(m,null,p(ja.value,(a=>(u(),l("div",{key:a._id,class:"image-select-item",onClick:e=>(a=>{Ia.value.coverImage=a,za.value=!1})(a)},[i(Ja,{hoverable:"",bodyStyle:{padding:"5px"}},{default:n((()=>[s("img",{src:k(sa).config.site.url+a.thumb,alt:a.filename,style:{width:"100%",height:"120px","object-fit":"cover"}},null,8,ia),s("p",na,c(a.filename),1)])),_:2},1024)],8,ua)))),128))])):(u(),o(Na,{key:0,description:"暂无图片可选"})),s("div",ta,[i(Ya,{current:Oa.value,"onUpdate:current":e[13]||(e[13]=a=>Oa.value=a),total:Fa.value,"page-size":Ka.value,onChange:Da},null,8,["current","total","page-size"])])])),_:1},8,["spinning"])])),_:1},8,["open"])])}}},[["__scopeId","data-v-5a7ba412"]]);export{sa as default};
