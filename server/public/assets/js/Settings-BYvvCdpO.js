import{_ as a,u as e,i as l}from"./index-CxgfQBo3.js";import{r as s,al as r,o,e as t,f as d,h as i,k as u,aa as n,m as c,i as v,aj as m,am as p,an as f,g as w,A as y,j as _,p as b,v as h,aK as g,a2 as P,ao as k,ap as x,aE as E,F as U,x as q,$ as C,I,a4 as F,U as j,aF as G,ar as K,aG as z}from"./vendor-DLaggKmm.js";const D={class:"settings"},H={class:"avatar-upload"},L={class:"social-accounts"},M={class:"accounts-grid"},S={key:0,class:"account-card"},$={class:"account-info"},A={key:0,class:"account-name"},B={key:1,class:"account-name"},O=["onClick"],R=["onClick"],T=a({__name:"Settings",setup(a){const T=e(),W=s("basic"),J=s(!1),N=s(0),Q=r({username:"",email:"",avatar:""}),V=r({oldPassword:"",newPassword:"",confirmPassword:""}),X=r({newEmail:"",code:""});o((()=>{var a,e,l;Q.username=null==(a=T.user)?void 0:a.username,Q.email=null==(e=T.user)?void 0:e.email,Q.avatar=null==(l=T.user)?void 0:l.avatar}));const Y=a=>a.toLowerCase().replace(/\s+/g,""),Z=async(a,e)=>{if(e!==V.newPassword)throw new Error("两次输入的密码不一致")},aa=a=>{if(!a.type.startsWith("image/"))return I.error("只能上传图片文件!"),!1;return!!(a.size/1024/1024<2)||(I.error("图片大小不能超过 2MB!"),!1)},ea=async({file:a})=>{var e;if(!J.value)try{const e=new FormData;e.append("image",a);const{data:s}=await l.post("/api/upload-avatar",e);Q.avatar=s.avatar,T.user.avatar=s.avatar,I.success("头像更新成功")}catch({response:s}){I.error((null==(e=null==s?void 0:s.data)?void 0:e.error)||"上传失败")}finally{J.value=!1}},la=async()=>{var a;try{J.value=!0,await l.post("/api/auth/change-password",F.stringify(V)),I.success("密码修改成功"),V.oldPassword="",V.newPassword="",V.confirmPassword=""}catch({response:e}){I.error((null==(a=null==e?void 0:e.data)?void 0:a.error)||"密码修改失败")}finally{J.value=!1}},sa=async()=>{var a,e,s;if(null==(e=null==(a=null==T?void 0:T.config)?void 0:a.smtp)?void 0:e.enabled)try{await l.post("/api/auth/user/send-code",F.stringify({email:X.newEmail,type:"email"})),I.success("验证码已发送"),N.value=60;const a=setInterval((()=>{N.value--,N.value<=0&&clearInterval(a)}),1e3)}catch({response:r}){I.error((null==(s=null==r?void 0:r.data)?void 0:s.error)||"发送验证码失败")}else I.warning("SMTP功能未开启, 请联系管理员")},ra=async()=>{var a;try{J.value=!0,await l.post("/api/auth/user/verify-code",F.stringify({email:X.newEmail,code:X.code})),I.success("邮箱修改成功"),Q.email=X.newEmail,X.newEmail="",X.code=""}catch({response:e}){I.error((null==(a=null==e?void 0:e.data)?void 0:a.error)||"邮箱修改失败")}finally{J.value=!1}};return(a,e)=>{const s=y,r=P,o=g,oa=f,ta=k,da=p,ia=m,ua=x,na=E,ca=n,va=C;return d(),t("div",D,[i(va,{title:"个人设置",bordered:!1},{default:u((()=>[i(ca,{activeKey:W.value,"onUpdate:activeKey":e[7]||(e[7]=a=>W.value=a)},{default:u((()=>{var a,n;return[i(ia,{key:"basic",tab:"基本信息"},{default:u((()=>[i(da,{model:Q,layout:"vertical"},{default:u((()=>[i(oa,null,{default:u((()=>{var a;return[w("div",H,[i(s,{size:100,src:_(T).config.site.url+(null==(a=_(T).user)?void 0:a.avatar)},{default:u((()=>[b(h(Q.username),1)])),_:1},8,["src"]),i(o,{name:"avatar","show-upload-list":!1,"before-upload":aa,customRequest:ea},{default:u((()=>[i(r,{type:"link"},{default:u((()=>{var a;return[b(h((null==(a=_(T).user)?void 0:a.avatar)?"更换头像":"上传头像"),1)]})),_:1})])),_:1})])]})),_:1}),i(oa,{label:"用户名"},{default:u((()=>[i(ta,{value:Q.username,"onUpdate:value":e[0]||(e[0]=a=>Q.username=a),disabled:""},{prefix:u((()=>[i(_(j))])),_:1},8,["value"])])),_:1}),i(oa,{label:"邮箱"},{default:u((()=>[i(ta,{value:Q.email,"onUpdate:value":e[1]||(e[1]=a=>Q.email=a),disabled:""},{prefix:u((()=>[i(_(G))])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1}),i(ia,{key:"password",tab:"修改密码"},{default:u((()=>[i(da,{model:V,onFinish:la,layout:"vertical"},{default:u((()=>[i(oa,{name:"oldPassword",label:"当前密码",rules:[{required:!0,message:"请输入当前密码"}]},{default:u((()=>[i(ua,{value:V.oldPassword,"onUpdate:value":e[2]||(e[2]=a=>V.oldPassword=a),placeholder:"请输入当前密码"},{prefix:u((()=>[i(_(K))])),_:1},8,["value"])])),_:1}),i(oa,{name:"newPassword",label:"新密码",rules:[{required:!0,message:"请输入新密码"},{min:6,message:"密码长度不能小于6位"}]},{default:u((()=>[i(ua,{value:V.newPassword,"onUpdate:value":e[3]||(e[3]=a=>V.newPassword=a),placeholder:"请输入新密码"},{prefix:u((()=>[i(_(K))])),_:1},8,["value"])])),_:1}),i(oa,{name:"confirmPassword",label:"确认密码",rules:[{required:!0,message:"请确认密码"},{validator:Z}]},{default:u((()=>[i(ua,{value:V.confirmPassword,"onUpdate:value":e[4]||(e[4]=a=>V.confirmPassword=a),placeholder:"请确认新密码"},{prefix:u((()=>[i(_(K))])),_:1},8,["value"])])),_:1},8,["rules"]),i(oa,null,{default:u((()=>[i(r,{type:"primary","html-type":"submit",disabled:!V.oldPassword||!V.newPassword||!V.confirmPassword,loading:J.value},{default:u((()=>e[8]||(e[8]=[b(" 修改密码 ")]))),_:1,__:[8]},8,["disabled","loading"])])),_:1})])),_:1},8,["model"])])),_:1}),i(ia,{key:"email",tab:"修改邮箱"},{default:u((()=>[i(da,{model:X,onFinish:ra,layout:"vertical"},{default:u((()=>[i(oa,{name:"newEmail",label:"新邮箱",rules:[{required:!0,message:"请输入新邮箱"},{type:"email",message:"请输入有效的邮箱地址"}]},{default:u((()=>[i(ta,{value:X.newEmail,"onUpdate:value":e[5]||(e[5]=a=>X.newEmail=a),placeholder:"请输入新邮箱"},{prefix:u((()=>[i(_(G))])),_:1},8,["value"])])),_:1}),i(oa,{name:"code",label:"验证码",rules:[{required:!0,message:"请输入验证码"}]},{default:u((()=>[i(na,{compact:""},{default:u((()=>[i(ta,{value:X.code,"onUpdate:value":e[6]||(e[6]=a=>X.code=a),placeholder:"请输入验证码",style:{width:"calc(100% - 120px)"}},{prefix:u((()=>[i(_(z))])),_:1},8,["value"]),i(r,{style:{width:"120px"},disabled:!!N.value||!X.newEmail,onClick:sa},{default:u((()=>[b(h(N.value?`${N.value}s后重试`:"获取验证码"),1)])),_:1},8,["disabled"])])),_:1})])),_:1}),i(oa,null,{default:u((()=>[i(r,{type:"primary","html-type":"submit",disabled:!X.newEmail||!X.code,loading:J.value},{default:u((()=>e[9]||(e[9]=[b(" 修改邮箱 ")]))),_:1,__:[9]},8,["disabled","loading"])])),_:1})])),_:1},8,["model"])])),_:1}),(null==(n=null==(a=_(T).config)?void 0:a.oauth)?void 0:n.enabled)?(d(),c(ia,{key:"bind",tab:"账号绑定"},{default:u((()=>[w("div",L,[e[11]||(e[11]=w("h3",{class:"section-title"},"社交账号绑定",-1)),w("div",M,[(d(),t(U,null,q(["GitHub","Google","Linux DO"],((a,s)=>{var r,o,i,u,n,c;return d(),t(U,{key:s},[(null==(i=null==(o=null==(r=_(T).config)?void 0:r.oauth)?void 0:o[Y(a)])?void 0:i.enabled)?(d(),t("div",S,[e[10]||(e[10]=w("div",{class:"account-icon"},null,-1)),w("div",$,[w("h4",null,h(a),1),(null==(c=null==(n=null==(u=_(T).user)?void 0:u.oauth)?void 0:n[Y(a)])?void 0:c.id)?(d(),t(U,{key:0},["GitHub"===a?(d(),t("p",A,h(_(T).user.oauth[Y(a)].username),1)):(d(),t("p",B,h(_(T).user.oauth[Y(a)].email),1)),w("button",{class:"unbind-btn",onClick:e=>(async a=>{var e;try{await l.post("/oauth/unbind",F.stringify({type:a,userId:T.user._id})),I.success("解绑成功"),location.reload()}catch({response:s}){I.error((null==(e=null==s?void 0:s.data)?void 0:e.error)||"解绑失败")}})(Y(a))},"解绑账号",8,O)],64)):(d(),t("button",{key:1,class:"bind-btn",onClick:e=>(async a=>{var e;const{oauth:s}=null==T?void 0:T.config;if(s.enabled)try{const{data:e}=await l.post("/oauth/bind",F.stringify({type:a,userId:T.user._id,redirectUrl:location.href}));location.href=e.authUrl}catch({response:r}){I.error((null==(e=null==r?void 0:r.data)?void 0:e.error)||"解绑失败")}else I.error("社会化登录功能未启用")})(Y(a))},"绑定账号",8,R))])])):v("",!0)],64)})),64))])])])),_:1})):v("",!0)]})),_:1},8,["activeKey"])])),_:1})])}}},[["__scopeId","data-v-d2b4caab"]]);export{T as default};
